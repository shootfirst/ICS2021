# 计算机系统

## 信息的表示与处理

## 程序的机器级表示

## 流水线

## 程序优化


## 存储体系结构

#### cache

cache line是cache和主存之间数据传输的最小单位。cache line大小决定`offset`位数。通过offset在cache line中读取指定数据

cache由cache line组成，通过`index`去定位cache line。

通过`tag`(中保存的是整个地址位宽去除index和offset使用的bit剩余部分)判断是否命中，对于直接映射，只需要比较一次，对于n路组相联，要去n个组里面一一比较

##### 组织结构

+ 一路组相联：一个地址对应一个cache line

+ n 路组相联：一个地址对应n个组里面的cache line

+ 全相联：没有index了，只有tag

##### 更新策略

+ 写回

+ 写直达

##### 不命中类型

+ 强制性不命中

+ 冲突不命中

+ 容量不命中




## 链接

### 符号

#### 定义

指被分配了存储空间。如果是函数名即指其代码所在区；变量名即指其所占的静态数据区
  
+ 所有定义符号的值就是其目标所在的首地址

+ 局部变量和参数等等经编译器处理后不再是符号

#### 类型

+ 全局符号

+ 外部符号

+ 本地符号

#### 作用

符号是链接的桥梁，链接的目的就是`确定各个符号被引用处所填的地址


### 静态链接

#### .symtab

作用：符号定义存储在目标文件中(由汇编器) 的符号表中.

结构体：
```
typedef struct {
  ELF32_Word st_name; // 符号名，记录在字符串表下标
  ELF32_Addr st_value; // 符号对应的值（地址）
  ...
}
```

#### rel.

作用：需要重定位的text和data会有指定的rel.text和rel.data节，存储需要重定位的符号信息

结构体：
```
typedef struct {
  ELF32_Addr r_offset;   // 该重定位入口需要修正指令的位置相对该节的偏移
  ELF32_Word r_info;  // 包括重定位入口类型（共享库类型为动态链接）和重定位入口的符号在符号表的位置
} Elf_32Rel;
```

#### 流程

##### 相似节合并

将相似节合并成段，确定所有符号的地址，合并所有符号表，写入全局符号表中

##### 符号解析与重定位

符号解析：通过重定位表获取对应符号在符号表中下标，在获取其地址

重定位：计算需要写入的地址，将该计算结果写入相关指令处



### 动态链接

在程序被exev加载入内存或者运行(dlopen)的时候，再将其链接

代码必须是地址无关代码，否则无法共享！

跨模块如何地址无关？got表！

#### .interp

作用：存储可执行文件所需要动态链接器的路径

#### .dynamic

作用：动态链接核心数据结构，存储依赖共享对象，动态链接符号表位置，动态链接重定位表位置，共享对象初始化代码位置

结构体：
```
typedef struct {
  ELf32_Sword d_tag; // 类型，如动态链接符号表，动态链接共享对象搜索路径，动态链接重定位表地址等
  union {
    ELF32_Word d_val;
    ELF32_Addr d_ptr;
  } d_un;  // 值
} ELF32_Dyn;
```

#### .dynsym

作用：类似于符号表，保存动态链接相关符号

#### .rel.dyn .rel.plt

作用：类似于重定位表，修正数据引用.got和修正函数引用.got.plt

#### 流程

##### 动态链接器自举

动态链接器不能依赖其他共享对象；动态链接器的自举代码不能使用全局变量和函数！

+ 找到GOT第一项，也就是.dynamic地址

+ 通过.dynamic中信息完成自身重定位

##### 装载共享对象

+ 合并所有符号到全局符号表

+ 通过.dynamic，装载其他所有共享对象（dfs或bfs），将其符号表合并，得到最终的全局符号表

+ 填充最终全局符号表

+ 通过动态重定位表，填充GOT和PLT表，动态链接完成


#### 运行时动态链接

通过dlopen dlsym和dlclose去显示装载共享对象，获取符号，卸载共享对象




## 虚拟内存

#### 作用

+ 方便链接

+ 隔离进程，保护操作系统安全

+ 利用局部性扩大内存

+ 鉴权，防止内存非法访问

#### 软硬件结合

硬件负责提供MMU与TLB，而软件操作系统负责维护管理页表TLB，同时处理pagefault

##### 名称缩写

TLBI: TLB index----TLB索引（定位）

TLBT: TLB tag----TLB标记（确定是否是当前PTE，有k路则需要比较k次，同缓存）

VA: virtual address----虚拟地址

PA: physical address----物理地址

PTE: page table entry----页表条目

PTEA：PTE address----页表条目地址

VPO: Virtual page offset----虚拟页面偏移量（字节）

VPN: Virtual page number----虚拟页号

PPO: Physical page offset (same as VPO)----物理页面偏移量

PPN: Physical page number----物理页号

#### 多级页表

节省内存



## 动态内存分配

#### malloc与free原理

#### 其他malloc库


